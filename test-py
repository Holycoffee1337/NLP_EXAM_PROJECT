from datasets import Dataset
import pandas as pd
import ast


df = pd.read_csv("studio-label-annotation.csv")

# If 'label' column is a string, convert it to a Python list
df['label'] = df['label'].apply(lambda x: ast.literal_eval(x) if isinstance(x, str) else x)

# Function to align text with its labels
def align_labels(text, labels):
    # Initialize the default tag sequence with "O"
    tokens = text.split()  # Split text into words
    tags = ['O'] * len(tokens)
    
    for label in labels:
        start = label["start"]
        end = label["end"]
        entity_text = label["text"]
        entity_label = label["labels"][0]  # Assuming only one label per entity
        
        # Mark tokens with appropriate tags
        current_position = 0
        for i, token in enumerate(tokens):
            token_start = current_position
            token_end = current_position + len(token)
            
            if start <= token_start < end or start < token_end <= end:  # Token overlaps with the entity
                if token_start == start:
                    tags[i] = f"B-{entity_label}"  # Beginning of the entity
                else:
                    tags[i] = f"I-{entity_label}"  # Inside the entity
            
            current_position += len(token) + 1  # Account for spaces

    return tokens, tags

# Process the 'text' and 'label' columns to extract tokens and tags
df[['tokens', 'tags']] = df.apply(
    lambda row: pd.Series(align_labels(row['text'], row['label'])), axis=1
)

# Create the Hugging Face Dataset
dataset = Dataset.from_pandas(df[['tokens', 'tags']])

# Inspect the processed dataset
print(dataset)